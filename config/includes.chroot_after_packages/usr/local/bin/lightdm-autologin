#!/bin/bash
#
# yad list for autologin.
set -e
# Yad function to list current autologin usernames.
userslist() (
grep -n 'autologin-user=*' /etc/lightdm/lightdm.conf | grep -v "#" | cut -d'=' -f2 > "/tmp/autologinlist.txt"
yad --text-info < /tmp/autologinlist.txt --fore=#4BEA80 \
	--fontname="JetBrains Mono Light 11" \
    --geometry=260x145-885+200 --borders=8 \
    --title="Enabled Users" \
    --button=" Exit!gtk-delete:1" \
    --window-icon="user-info"
)

export -f "userslist"

bash -c "userslist" &

## Get the list of usernames from /etc/passwd.
ret=($(cut -d: -f1,3 /etc/passwd | grep -E ':[0-9]{4}$' | cut -d: -f1))

# Adjust list for yad use.
LIST=""
for ((j=0; j<${#ret[*]}; j++));do
    p="${ret[$j]}"
    LIST="${LIST}FALSE $p "
done

LOGIN=$(yad --list --center --borders=8 \
    --title="Autologin Toggle" \
    --window-icon="user-info" \
    --text="                  Toggle Selection On/Off" \
    --radiolist --geometry=314x230-860+400 \
    --column="Select" --column="Username" $LIST --separator="" \
    --button=" Cancel!gtk-cancel:1" \
    --button=" Toggle!gtk-ok:0" \
    )

# If canceled
if (( $? == 1 )); then
    exit 0
else
# Continue Chosen Selection.
SELECTION=${LOGIN//"TRUE"}
fi

# Toggle selection on/off.
if grep -q "$SELECTION" /etc/lightdm/lightdm.conf; then
pkexec sed -i '/autologin-user='"$SELECTION"'/d' /etc/lightdm/lightdm.conf
notify-send -i "user-info" --urgency low "Autologin for $SELECTION has changed"
else
pkexec sed -i '125aautologin-user='"$SELECTION"'' /etc/lightdm/lightdm.conf
notify-send -i "user-info" --urgency low "Autologin for $SELECTION has changed"
fi
kill -- -0
